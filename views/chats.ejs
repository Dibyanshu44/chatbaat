<%- include("partials/header.ejs") %>
<main>
    <div class="container">
        <a href="/home?user=<%= user1 %>" class="back-button">← Back to Home</a>

        <h3><%= user2 %></h3>
        <div class="chat-window" id="chat-window">
           <% for(var i=0; i < chats.length; i++) {
                var number = chats[i].split("`");
                var parts = number[1].split(": ");
                var sender = parts[0];
                var message = parts.slice(1).join(": ");
                var isSender = (sender === user1);
           %>
            <div class="chat-options" id="<%= i %>">
                <p>
                    <strong><%= sender %></strong>
                    <% if (isSender) { %>
                        <span class="chat-icons">
                            <a href="/edit/<%= user2 %>?user=<%= user1 %>&j=<%= i %>" class="edit" title="Edit message">✏️</a>
                            <a href="/dlt/<%= user2 %>?user=<%= user1 %>&j=<%= i %>" class="dlt" title="Delete message">🗑️</a>
                        </span>
                    <% } %>
                    : <%= message %>
                </p>
            </div>
           <% } %>
        </div>
        <% var j=chats.length %>
        <form id="chat-form" method="post" action="/chat/<%= user2 %>?user=<%= user1 %>&j=<%= j %>">
            <input type="text" name="msg" placeholder="Enter message" required>
            <input type="submit" value="send">
        </form>
    </div>
</main>

<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io();
    var user1 = "<%= user1 %>";
    var user2 = "<%= user2 %>";
    var room = [user1, user2].sort().join("_");

    socket.emit("joinRoom", room);

    var chatWindow = document.getElementById("chat-window");

    socket.on("message", function(data) {
        var div = document.createElement("div");
        div.classList.add("chat-options");

        var html = "<p><strong>" + data.sender + "</strong>";
        if (data.sender === user1) {
            html +=
                ' <span class="chat-icons">' +
                '<a href="/edit/' + user2 + '?user=' + user1 + '&j=' + data.index + '" class="edit" title="Edit message">✏️</a>' +
                '<a href="/dlt/' + user2 + '?user=' + user1 + '&j=' + data.index + '" class="dlt" title="Delete message">🗑️</a>' +
                '</span>';
        }
        html += ": " + data.message + "</p>";

        div.innerHTML = html;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    });

    chatWindow.scrollTop = chatWindow.scrollHeight;
</script>

<%- include("partials/footer.ejs") %>
