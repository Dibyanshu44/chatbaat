<%- include("partials/header.ejs") %>
<main>
    <div class="container">
        <a href="/home?user=<%= user1 %>" class="back-button">‚Üê Back to Home</a>

        <h3><%= user2 %></h3>
        <div class="chat-window" id="chat-window">
            <% for (var i = 0; i < chats.length; i++) {
                var number = chats[i].split("`");
                var parts = number[1].split(": ");
                var sender = parts[0];
                var message = parts.slice(1).join(": ");
                var isSender = (sender === user1);
            %>
                <div class="chat-options" id="<%= i %>">
                    <div class="chat-header" style="display:flex; justify-content: space-between; align-items: center;">
                        <strong><%= sender %>:</strong>
                        <% if (isSender) { %>
                            <span class="chat-icons">
                                <a href="/edit/<%= user2 %>?user=<%= user1 %>&j=<%= i %>" class="edit" title="Edit message">‚úèÔ∏è</a>
                                <a href="/dlt/<%= user2 %>?user=<%= user1 %>&j=<%= i %>" class="dlt" title="Delete message">üóëÔ∏è</a>
                            </span>
                        <% } %>
                    </div>
                    <div class="chat-message-box" style="border: 1px solid #ccc; padding: 6px 10px; margin-top: 4px; border-radius: 6px;">
                        <%= message %>
                    </div>
                </div>
            <% } %>
        </div>

        <% var j = chats.length; %>
        <form id="chat-form" method="post" action="/chat/<%= user2 %>?user=<%= user1 %>&j=<%= j %>">
            <input type="text" name="msg" placeholder="Enter message" required>
            <input type="submit" value="send">
        </form>
    </div>
</main>

<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io();
    var user1 = "<%= user1 %>";
    var user2 = "<%= user2 %>";
    var room = [user1, user2].sort().join("_");

    socket.emit("joinRoom", room);

    var chatWindow = document.getElementById("chat-window");

    // Listen for new messages
    socket.on("message", function (data) {
        var div = document.createElement("div");
        div.classList.add("chat-options");
        div.id = data.index;

        var html = '<div class="chat-header" style="display:flex; justify-content: space-between; align-items: center;">' +
            '<strong>' + data.sender + ':</strong>';

        if (data.sender === user1) {
            html += '<span class="chat-icons">' +
                '<a href="/edit/' + user2 + '?user=' + user1 + '&j=' + data.index + '" class="edit" title="Edit message">‚úèÔ∏è</a>' +
                '<a href="/dlt/' + user2 + '?user=' + user1 + '&j=' + data.index + '" class="dlt" title="Delete message">üóëÔ∏è</a>' +
                '</span>';
        }

        html += '</div>' +
            '<div class="chat-message-box" style="border: 1px solid #ccc; padding: 6px 10px; margin-top: 4px; border-radius: 6px;">' +
            data.message +
            '</div>';

        div.innerHTML = html;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    });

    // Listen for edits
    socket.on("editMessage", function (data) {
        var chatDiv = document.getElementById(data.index);
        if (chatDiv) {
            var messageBox = chatDiv.querySelector(".chat-message-box");
            if (messageBox) {
                messageBox.textContent = data.message;
            }
        }
    });

    chatWindow.scrollTop = chatWindow.scrollHeight;
</script>
<%- include("partials/footer.ejs") %>
